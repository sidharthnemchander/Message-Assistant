<!DOCTYPE html>
<html>
  <head>
    <title>Email and Telegram DM Unify</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      #GotMail,
      #GotCategory {
        margin-top: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Email and Telegram Assistant</h1>
    <button onclick="getMails()">Get Emails</button>
    <button onclick="getCategory()">Get Categories</button>
    <div id="GotMail">Click "Get Emails" button to sync emails</div>
    <div id="GotCategory">
      Click "Get Categories" button to categorize emails
    </div>
    <button onclick="checkCategories">Check Categories</button>
    <div id="CheckCategory">Click Check Categories Please</div>

    <script>
      const GotMail = document.getElementById("GotMail");
      const categories = document.getElementById("GotCategory");
      const checkCategoryDiv = document.getElementById("CheckCategory");

      let clientState = {
        subjectsToBody: {},
        categorizedEmails: {},
      };
      async function getMails() {
        GotMail.textContent = "Loading...";
        try {
          const response = await fetch("/getMail", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          });
          const res = await response.json();
          if (response.ok) {
            GotMail.innerHTML = `<pre>${JSON.stringify(res, null, 2)}</pre>`;
          } else {
            GotMail.textContent = `Error: ${
              res.detail || "Failed to fetch emails"
            }`;
          }
        } catch (error) {
          GotMail.textContent = "Error: " + error.message;
        }
      }

      async function getCategory() {
        categories.textContent = "Please wait while we are sorting...";
        try {
          const response = await fetch("/GetCategories", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          });
          const res = await response.json();
          if (response.ok) {
            categories.innerHTML = `<pre>${JSON.stringify(res, null, 2)}</pre>`;
          } else {
            categories.textContent =
              "ERROR: " + (res.detail || "Failed to categorize");
          }
        } catch (error) {
          categories.textContent = "ERROR: " + error.message;
        }
      }
      async function checkCategories() {
        checkCategoryDiv.textContent = "Fetching category data...";
        try {
          const response = await fetch("/checkCategoryData", {
            method: "POST",
          });
          const res = await response.json();
          if (!response.ok) throw new Error(res.detail);

          clientState.categorizedEmails = res.categorized_emails;
          renderCategoryList();
        } catch (error) {
          checkCategoryDiv.textContent = "ERROR: " + error.message;
        }
      }
      function renderCategoryList() {
        let html = "<h3>Click a Category to View Subjects:</h3>";
        for (const category in clientState.categorizedEmails) {
          // Note: We pass the category name as a string argument
          html += `<div class="list-item" onclick="renderSubjectList('${category}')">${category} (${clientState.categorizedEmails[category].length} emails)</div>`;
        }
        checkCategoryDiv.innerHTML = html;
      }
      function renderSubjectList(categoryName) {
        const subjects = clientState.categorizedEmails[categoryName];
        let html = `<h3>Subjects in ${categoryName}:</h3>`;
        subjects.forEach((subject) => {
          // Escape quotes in the subject to prevent breaking the HTML string
          const escapedSubject = subject
            .replace(/'/g, "\\'")
            .replace(/"/g, "&quot;");
          html += `<div class="list-item" onclick="renderEmailView('${escapedSubject}')">${subject}</div>`;
        });
        checkCategoryDiv.innerHTML = html;
      }

      function renderEmailView(subject) {
        const body = clientState.subjectsToBody[subject];
        const escapedSubject = subject
          .replace(/'/g, "\\'")
          .replace(/"/g, "&quot;");
        let html = `
          <h3>${subject}</h3>
          <button onclick="summarizeEmail('${escapedSubject}')">Summarize with AI</button>
          <hr>
          <div style="white-space: pre-wrap;">${body || "Body not found."}</div>
      `;
        checkCategoryDiv.innerHTML = html;
      }

      async function summarizeEmail(subject) {
        checkCategoryDiv.innerHTML = "<h3>Summarizing...</h3>";
        try {
          const response = await fetch("/summarizeEmail", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subject: subject }),
          });
          const res = await response.json();
          if (!response.ok) throw new Error(res.detail);

          let html = `
              <h3>Summary for: ${subject}</h3>
              <div style="white-space: pre-wrap; background-color: #eef; padding: 10px; border-radius: 5px;">${res.summary}</div>
          `;
          checkCategoryDiv.innerHTML = html;
        } catch (error) {
          checkCategoryDiv.innerHTML =
            "<h3>ERROR</h3><p>" + error.message + "</p>";
        }
      }
    </script>
  </body>
</html>
